# AppMetrica Installs Antifraud
 Антифрод для новых установок на базе AppMetrica

> **Решаемая проблема**<br>
> После запуска рекламных in-app кампаний количество установок выросло кратно без соответствующего роста заказов в CRM. Дополнительные установки также полились в органику. Некоторые in-app трекеры генерировали несуществующие действия в AppMetrica, например, событие покупки, айди которых не было в CRM. Порой воронка по in-app могла достигать 100% конверсии по 5 шагам, что естественно невозможно для тысяч установок.
>
> <b>Необходимо было определить корректных пользователей до user_id. </b>
 
 Запрос возвращает id настоящих пользователей

## Описание используемых таблиц и полей
|Таблица|Описание|
| --- | --- |
|appmetrica_installs|Выгрузка Logs API /logs/v1/export/installations|
|appmetrica_profiles|Выгрузка Logs API /logs/v1/export/profiles|
|appmetrica_sessions|Выгрузка Logs API /logs/v1/export/sessions_starts|

<br>

|Кастомное поле в таблице appmetrica_profiles|Описание|
| --- | --- |
|device_id|Уникальный айди устройства, созданный каким угодно образом самостоятельно. Приходит с бекэнда и присваивается при каждом запуске приложения|
|client_id|Идентификатор авторизованного пользователя из CRM #1. Присваивается при авторизации|
|gold_id|Идентификатор авторизованного пользователя из CRM #2. Присваивается при авторизации|

## Описание логики фильтрации корректных установок
### Авторизованная зона
```sql
(client_id IS NOT NULL) OR (gold_id IS NOT NULL)
```
Если CRM присвоила пользователю айди (пользователь авторизовался), то он настоящий

### Неавторизованная зона
```sql
((device_id IS NOT NULL) AND (mcc_mnc > 0) AND (os_name = profiles_os_name))
```
```device_id IS NOT NULL``` - данный айди обязан быть у каждого устройства
<br>
```mcc_mnc``` - AppMetrica собирает значение ```mcc/mnc``` для андроида (для ios всегда заполняются 0). Сумма этих значений должна быть > 0
<br>
```os_name = profiles_os_name``` - у фродовых установок поле ```os_name``` может не совпадать в таблицах ```profiles``` и ```installations```
<br><br>
Логическое И между вышеперечисленными тремя условиями выявляет настоящего пользователя

## Результаты антифрода
|Источник установки|Доля авторизаций|Доля фрода|Доля реальных заказов, помеченных как фрод|
| --- | --- | --- | --- |
|Оффлайн установки по QR коду|94,9%|0,6%|0%|
|Органика из стора до in-app кампаний|49,5%|8,5%|0%|
|Платные in app установки|4,2%|93,8%|0%|

Скрипт показывает меньше 1% фрода у настоящих клиентов, которые устанавливают приложение оффлайн через QR код. Также скрипт определил, что in-app кампании состоят практически полностью из фродовых установок. Более того, скрипт не отметил пользователей с реальными заказами как фродовые ни в одном источнике установок.
